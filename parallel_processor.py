import os
from pydub import AudioSegment
from audio_cleaner import clean_stutter

def combine_chunks(chunk_files, output_file="shriram_final_pro.wav"):
    """
    рд╕рднреА рдСрдбрд┐рдпреЛ рдЯреБрдХрдбрд╝реЛрдВ рдХреЛ рдкреНрд░реЛрд╕реЗрд╕ рдХрд░рдХреЗ рдПрдХ рдлрд╛рдЗрдирд▓ рдлрд╛рдЗрд▓ рдмрдирд╛рддрд╛ рд╣реИред
   
    """
    if not chunk_files:
        return None

    # рдЦрд╛рд▓реА рдСрдбрд┐рдпреЛ рд╕реЗрдЧрдореЗрдВрдЯ рдмрдирд╛рдирд╛
    combined = AudioSegment.empty()
    
    print(f"ЁЯФД рдХреБрд▓ {len(chunk_files)} рдЯреБрдХрдбрд╝реЛрдВ рдХреЛ рдЬреЛрдбрд╝рд╛ рдЬрд╛ рд░рд╣рд╛ рд╣реИ...")

    for file in chunk_files:
        if os.path.exists(file):
            try:
                # 1. рдкрд╣рд▓реЗ рд╣рд░ рдЯреБрдХрдбрд╝реЗ рд╕реЗ рд╕рдиреНрдирд╛рдЯрд╛ рдФрд░ рд╣рдХрд▓рд╛рдирд╛ рд╣рдЯрд╛рдирд╛
                clean_stutter(file)
                
                # 2. рд╕рд╛рдл рдХрд┐рдП рдЧрдП рдЯреБрдХрдбрд╝реЗ рдХреЛ рдореБрдЦреНрдп рдлрд╛рдЗрд▓ рдореЗрдВ рдЬреЛрдбрд╝рдирд╛
                combined += AudioSegment.from_wav(file)
                
                # 3. рдХрд╛рдо рд╣реЛрдиреЗ рдХреЗ рдмрд╛рдж рдЫреЛрдЯреЗ рдЯреБрдХрдбрд╝реЗ рдХреЛ рдбрд┐рд▓реАрдЯ рдХрд░рдирд╛ (рдореЗрдореЛрд░реА рдмрдЪрд╛рдиреЗ рдХреЗ рд▓рд┐рдП)
                os.remove(file)
            except Exception as e:
                print(f"тЪая╕П рдлрд╛рдЗрд▓ {file} рдХреЛ рдЬреЛрдбрд╝рдиреЗ рдореЗрдВ рдПрд░рд░: {e}")
        else:
            print(f"тЭМ рдлрд╛рдЗрд▓ рдирд╣реАрдВ рдорд┐рд▓реА: {file}")

    # 4. рдлрд╛рдЗрдирд▓ рдлрд╛рдЗрд▓ рдХреЛ рд╕реЗрд╡ рдХрд░рдирд╛
    combined.export(output_file, format="wav")
    print(f"тЬЕ рдлрд╛рдЗрдирд▓ рдСрдбрд┐рдпреЛ рддреИрдпрд╛рд░: {output_file}")
    
    return output_file
