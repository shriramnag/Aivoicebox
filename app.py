import os
import gradio as gr
from TTS.api import TTS

# ЁЯЪй рдлрд╛рдЗрд▓ рдкрд╛рде рд╕реЗрдЯрд┐рдВрдЧреНрд╕ (рдЖрдкрдХреЗ рд░рд┐рдкреЙрдЬрд┐рдЯрд░реА рдХреЗ рдЕрдиреБрд╕рд╛рд░)
# рдзреНрдпрд╛рди рджреЗрдВ: рдХреЛрд▓рд╛рдм рдореЗрдВ рд░рди рдХрд░рддреЗ рд╕рдордп рдпрд╣ рдкрд╛рде рд╕рд╣реА рд╣реЛрдирд╛ рдЪрд╛рд╣рд┐рдП
BASE_PATH = "/content/Aivoicebox" 
MODEL_PATH = os.path.join(BASE_PATH, "Ramai.pth")
CONFIG_PATH = os.path.join(BASE_PATH, "config.json")
SPEAKER_WAV = os.path.join(BASE_PATH, "speaker.wav")

print("ЁЯЪА рд╢реНрд░реАрд░рд╛рдо рд╡рд╛рдгреА рд╡рд░реНрдХрд┐рдВрдЧ рдореЙрдбрд▓ рд▓реЛрдб рд╣реЛ рд░рд╣рд╛ рд╣реИ...")

# XTTS v2 рд▓реЛрдб рдХрд░рдирд╛ (рдмрд┐рдирд╛ рдХрд┐рд╕реА рдмрд╛рд╣рд░реА рдбрд╛рдЙрдирд▓реЛрдб рдПрд░рд░ рдХреЗ) [cite: 2026-01-06]
try:
    tts = TTS("tts_models/multilingual/multi-dataset/xtts_v2", gpu=True)
except Exception as e:
    print(f"рдЗрдВрдЬрди рд▓реЛрдб рдХрд░рдиреЗ рдореЗрдВ рд╕рдорд╕реНрдпрд╛: {e}")

def generate_shriram_voice(input_text):
    if not input_text.strip():
        return "рдХреГрдкрдпрд╛ рдХреБрдЫ рдЯреЗрдХреНрд╕реНрдЯ рд▓рд┐рдЦреЗрдВ..."
    
    output_file = "shriram_final_output.wav"
    
    try:
        # ЁЯОЩя╕П рдЖрдкрдХреА рдорд╛рд╕реНрдЯрд░ рд╕реЗрдЯрд┐рдВрдЧреНрд╕ (Locked)
        # рдЗрд╕рдореЗрдВ 0.9 Deep Match рдФрд░ 1.0 Emotion рдХрд╛ рдкреНрд░рднрд╛рд╡ рд╕реЗрдЯ рд╣реИ
        tts.tts_to_file(
            text=input_text,
            speaker_wav=SPEAKER_WAV, 
            language="hi",
            file_path=output_file,
            speed=1.0,               # рдЯрд░реНрдмреЛ рд╣рд╛рдИ рд╕реНрдкреАрдб [cite: 2026-01-06]
            repetition_penalty=10.0,   # рд╣рдХрд▓рд╛рд╣рдЯ рд░реЛрдХрдиреЗ рдХреЗ рд▓рд┐рдП
            temperature=0.75,          # рдЧрд╣рд░рд╛рдИ рдФрд░ рдЗрдореЛрд╢рди рдХреЗ рд▓рд┐рдП
            gpt_cond_len=3             # рд╕рдЯреАрдХ рдХреНрд▓реЛрдирд┐рдВрдЧ рдХреЗ рд▓рд┐рдП
        )
        return output_file
    
    except Exception as e:
        return f"рддреНрд░реБрдЯрд┐: {str(e)}"

# ЁЯЪй рдЧреНрд░рд╛рдлрд┐рдХрд▓ рдЗрдВрдЯрд░рдлреЗрд╕ (UI) - рдЬреЛ рдХреЛрд▓рд╛рдм рдореЗрдВ рдкрдмреНрд▓рд┐рдХ рд▓рд┐рдВрдХ рджреЗрдЧрд╛
with gr.Blocks(title="ЁЯЪй рд╢реНрд░реАрд░рд╛рдо рд╡рд╛рдгреА - AI рдорд╛рд╕реНрдЯрд░ ЁЯЪй") as demo:
    gr.Markdown("# ЁЯЪй рд╢реНрд░реАрд░рд╛рдо рд╡рд╛рдгреА - рд╣рд┐рдВрджреА рд╡реЙрдпрд╕ рдХреНрд▓реЛрди рдЯрд░реНрдмреЛ")
    gr.Markdown("### рдкреБрд░рд╛рдиреА рд╡рд░реНрдХрд┐рдВрдЧ рд╕реЗрдЯрд┐рдВрдЧреНрд╕ рдФрд░ рд╣рд╛рдИ рд╕реНрдкреАрдб рдХреЗ рд╕рд╛рде [cite: 2026-01-06]")
    
    with gr.Row():
        with gr.Column():
            input_box = gr.Textbox(
                label="рдЕрдкрдиреА рд╕реНрдХреНрд░рд┐рдкреНрдЯ рдпрд╣рд╛рдБ рд▓рд┐рдЦреЗрдВ", 
                lines=8, 
                placeholder="рдпрд╣рд╛рдБ рд╣рд┐рдВрджреА рдЯреЗрдХреНрд╕реНрдЯ рдкреЗрд╕реНрдЯ рдХрд░реЗрдВ..."
            )
            btn = gr.Button("рдЖрд╡рд╛реЫ рдЬрдирд░реЗрдЯ рдХрд░реЗрдВ ЁЯЪА", variant="primary")
        
        with gr.Column():
            output_audio = gr.Audio(label="рд╕реБрдирд┐рдП рд╢реНрд░реАрд░рд╛рдо рд╡рд╛рдгреА", type="filepath")

    # рдмрдЯрди рдХреНрд▓рд┐рдХ рдПрдХреНрд╢рди
    btn.click(fn=generate_shriram_voice, inputs=input_box, outputs=output_audio)

# ЁЯЪй рдкрдмреНрд▓рд┐рдХ рдпреВрдЖрд░рдПрд▓ (Public URL) рдХреЗ рд▓рд┐рдП рд╢реЗрдпрд░ рдЪрд╛рд▓реВ рдХрд░рдирд╛
if __name__ == "__main__":
    # share=True рд╕реЗ рдХреЛрд▓рд╛рдм рдореЗрдВ рдиреАрд▓рд╛ рд▓рд┐рдВрдХ рдорд┐рд▓реЗрдЧрд╛
    demo.launch(share=True, debug=True)
