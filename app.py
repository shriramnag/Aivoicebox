import os, re, gc, torch, gradio as gr, requests
from TTS.api import TTS
from huggingface_hub import hf_hub_download
from pydub import AudioSegment, effects

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# เฅง. เคถเคฟเคต AI เคฎเคธเฅเคคเคฟเคทเฅเค (DIMAAG LOGIC) - v1.01
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# เคฏเคน เคนเคฟเคธเฅเคธเคพ เคเคเคเฅเคฒเคฟเคถ เคถเคฌเฅเคฆเฅเค เคเฅ เคนเคฟเคเคฆเฅ เคเคเฅเคเคพเคฐเคฃ เคฎเฅเค เคฌเคฆเคฒเคคเคพ เคนเฅ เคคเคพเคเคฟ AI เคจ เคนเคเคฒเคพเค
BRAIN_MEMORY = {
    "AI": "เค เคเค", "YouTube": "เคฏเฅเคเฅเคฏเฅเคฌ", "WhatsApp": "เคตเฅเคนเคพเคเฅเคธเคเคช",
    "Instagram": "เคเคเคธเฅเคเคพเคเฅเคฐเคพเคฎ", "Facebook": "เคซเฅเคธเคฌเฅเค", "Google": "เคเฅเคเคฒ",
    "Technology": "เคเฅเคเฅเคจเฅเคฒเฅเคเฅ", "Video": "เคตเฅเคกเคฟเคฏเฅ", "Subscribe": "เคธเคฌเฅเคธเคเฅเคฐเคพเคเคฌ",
    "Online": "เคเคจเคฒเคพเคเคจ", "Update": "เคเคชเคกเฅเค", "Mobile": "เคฎเฅเคฌเคพเคเคฒ"
}

def shiv_v1_brain_processor(text):
    """เคฎเคธเฅเคคเคฟเคทเฅเค: เคจเคเคฌเคฐเฅเค เคเคฐ เคเคเคเฅเคฒเคฟเคถ เคเฅ เคนเคฟเคเคฆเฅ เคเคเฅเคเคพเคฐเคฃ เคฎเฅเค เคฌเคฆเคฒเคจเคพ"""
    # เคจเคเคฌเคฐเฅเค เคเคพ เคถเฅเคฆเฅเคงเคฟเคเคฐเคฃ
    nums = {'0':'เคถเฅเคจเฅเคฏ','1':'เคเค','2':'เคฆเฅ','3':'เคคเฅเคจ','4':'เคเคพเคฐ','5':'เคชเคพเคเค','6':'เคเคน','7':'เคธเคพเคค','8':'เคเค','9':'เคจเฅ'}
    for n, w in nums.items(): text = text.replace(n, w)
    
    # เคเคเคเฅเคฒเคฟเคถ เคถเคฌเฅเคฆเฅเค เคเคพ เคธเฅเคงเคพเคฐ
    for eng, hin in BRAIN_MEMORY.items():
        text = re.sub(r'\b' + eng + r'\b', hin, text, flags=re.IGNORECASE)
    
    # เคเฅเคตเคฒ เคเคพเคฎ เคเฅ เคเฅเคฐเฅเคเฅเคเคฐเฅเคธ เคฐเคเคจเคพ
    text = re.sub(r'[^\w\sเฅค!?.,-]', '', text)
    return text.strip()

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# เฅจ. เคฎเคพเคธเฅเคเคฐ เคฎเฅเคกเคฒ เคเคฐ เคธเฅเคฐเคเฅเคทเคพ เคเคตเค
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
os.environ["COQUI_TOS_AGREED"] = "1"
device = "cuda" if torch.cuda.is_available() else "cpu"

print("๐ เคถเคฟเคต AI v1.01 เคฎเคธเฅเคคเคฟเคทเฅเค เคเคพเคเฅเคฐเคค เคนเฅ เคฐเคนเคพ เคนเฅ...")
tts = TTS("tts_models/multilingual/multi-dataset/xtts_v2").to(device)

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# เฅฉ. เคเคจเคฐเฅเคถเคจ เคเคเคเคจ (เคนเคเคฒเคพเคนเค-เคฎเฅเคเฅเคค)
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
def generate_shiv_v1_fixed(text, up_ref, git_ref, speed, progress=gr.Progress()):
    if not text: return None
    
    # เคฆเคฟเคฎเคพเค เคธเฅ เคเฅเคเคพเคฐเฅเค
    processed_text = shiv_v1_brain_processor(text)
    
    ref = up_ref if up_ref else "ref.wav"
    if not up_ref:
        G_RAW = "https://raw.githubusercontent.com/shriramnag/Aivoicebox/main/%F0%9F%93%81%20voices/"
        url = G_RAW + requests.utils.quote(git_ref)
        with open("ref.wav", "wb") as f: f.write(requests.get(url).content)

    # เคตเคพเคเฅเคฏเฅเค เคเฅ เคฌเคนเฅเคค เคเฅเคเคพ เคเคฐเคจเคพ (Micro-Chunks) เคคเคพเคเคฟ AI เคญเคเคเฅ เคจเคนเฅเค
    chunks = re.split(r'(?<=[เฅค!?เฅฅ.])\s+', processed_text)
    combined = AudioSegment.empty()
    
    

    for i, chunk in enumerate(chunks):
        if len(chunk.strip()) < 2: continue
        progress((i+1)/len(chunks), desc=f"เคถเฅเคฆเฅเคง เคเคเฅเคเคพเคฐเคฃ: {i+1}/{len(chunks)}")
        out = f"temp_{i}.wav"
        
        # เฅงเฅฆเฅฆเฅฆ% เคถเฅเคฆเฅเคง เคธเฅเคเคฟเคเคเฅเคธ: 
        # Temp 0.01 (เคจเฅ เคเคจเฅเคซเฅเคฏเฅเคเคจ), Penalty 15.0 (เคจเฅ เคนเคเคฒเคพเคนเค), Top_k 1 (เคธเคฌเคธเฅ เคธเคพเฅ เคเคตเคพเฅ)
        tts.tts_to_file(text=chunk, speaker_wav=ref, language="hi", file_path=out, 
                        speed=speed, repetition_penalty=15.0, temperature=0.01, top_k=1)
        
        combined += AudioSegment.from_wav(out)
        os.remove(out)
        torch.cuda.empty_cache(); gc.collect()

    final_path = "Shiv_AI_v1_01_Dimaag_Success.wav"
    combined.export(final_path, format="wav")
    return final_path

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# เฅช. เคฆเคฟเคตเฅเคฏ เคเคเคเคฐเคซเคผเฅเคธ
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
with gr.Blocks(theme=gr.themes.Soft(primary_hue="orange")) as demo:
    gr.Markdown("# ๐ฉ เคถเคฟเคต AI (Shiv AI) v1.01 โ เคถเฅเคฐเฅ เคฐเคพเคฎ เคจเคพเค")
    gr.Markdown("### 'เคฎเคธเฅเคคเคฟเคทเฅเค เคเคชเคกเฅเค' - เคนเคเคฒเคพเคนเค เคเคฐ เคตเคฟเคฆเฅเคถเฅ เคญเคพเคทเคพ เฅงเฅฆเฅฆเฅฆ% เคฌเคเคฆ ๐")
    
    with gr.Row():
        with gr.Column(scale=2):
            txt = gr.Textbox(label="เคเคชเคจเฅ เคธเฅเคเฅเคฐเคฟเคชเฅเค เคฏเคนเคพเค เคฒเคฟเคเฅเค (English เคถเคฌเฅเคฆ เคญเฅ เคฒเคฟเค เคธเคเคคเฅ เคนเฅเค)", lines=10)
            spd = gr.Slider(0.9, 1.4, 1.15, label="เคฐเฅเฅเคคเคพเคฐ (Speed)")
        with gr.Column(scale=1):
            git_v = gr.Dropdown(choices=["aideva.wav"], label="เคฎเคพเคธเฅเคเคฐ เคตเฅเคเคธ", value="aideva.wav")
            up_v = gr.Audio(label="เคเคฐเคฟเคเคฟเคจเคฒ เคเคตเคพเฅ เคเคชเคฒเฅเคก เคเคฐเฅเค", type="filepath")
            btn = gr.Button("๐ เคฌเฅเคฐเคนเฅเคฎเคพเคธเฅเคคเฅเคฐ เคเคจเคฐเฅเคถเคจ เคถเฅเคฐเฅ เคเคฐเฅเค", variant="primary")
            
    out = gr.Audio(label="Shri Ram Nag Final Output", type="filepath", autoplay=True)
    btn.click(generate_shiv_v1_fixed, [txt, up_v, git_v, spd], [out])

demo.launch(share=True)
